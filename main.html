<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Realtime Chat</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background-color: #f6f8fa; 
        }
        
        /* Шапка */
        header { 
            background: #24292e; 
            color: white; 
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-box { display: flex; align-items: center; gap: 10px; }
        .user-box input {
            background: #3f4448;
            border: 1px solid #444d56;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
        }

        /* Окно сообщений */
        #chat-window { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .message { 
            background: white; 
            padding: 12px 16px; 
            border-radius: 12px; 
            max-width: 85%; 
            width: fit-content;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e1e4e8;
        }
        .message .user { font-weight: 600; color: #0969da; font-size: 0.9em; display: block; margin-bottom: 4px; }
        .message .text { color: #1f2328; line-height: 1.5; word-break: break-word; }

        /* Поле ввода */
        footer { 
            background: white; 
            padding: 20px; 
            display: flex; 
            gap: 12px; 
            border-top: 1px solid #d0d7de;
        }
        #msg-text { 
            flex: 1; 
            padding: 12px 16px; 
            border: 1px solid #d0d7de; 
            border-radius: 8px; 
            outline: none; 
            font-size: 16px;
            transition: border 0.2s;
        }
        #msg-text:focus { border-color: #0969da; box-shadow: 0 0 0 3px rgba(9,105,218,0.1); }
        
        #send-btn { 
            background: #1f883d; 
            color: white; 
            border: none; 
            padding: 0 24px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 14px;
        }
        #send-btn:hover { background: #1a7f37; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">Public Chat</div>
    <div class="user-box">
        <span>Ваш ник:</span>
        <input type="text" id="username" placeholder="Аноним" maxlength="15">
    </div>
</header>

<div id="chat-window"></div>

<footer>
    <input type="text" id="msg-text" placeholder="Введите сообщение..." autocomplete="off">
    <button id="send-btn">Отправить</button>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Ваши данные (уже вставлены)
    const firebaseConfig = {
        apiKey: "AIzaSyD2KBDPMea8hWT4vv9ac613bQboI4hpAVU",
        authDomain: "chat-a5fe6.firebaseapp.com",
        databaseURL: "https://chat-a5fe6-default-rtdb.firebaseio.com",
        projectId: "chat-a5fe6",
        storageBucket: "chat-a5fe6.firebasestorage.app",
        messagingSenderId: "297636975324",
        appId: "1:297636975324:web:de823d9d84a7abc3801a19"
    };

    // Инициализация
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, 'chat_data');

    const chatWindow = document.getElementById('chat-window');
    const msgInput = document.getElementById('msg-text');
    const userInput = document.getElementById('username');
    const sendBtn = document.getElementById('send-btn');

    // Подгружаем ник из памяти браузера, если он там есть
    userInput.value = localStorage.getItem('chat_nickname') || "";

    // Функция отправки
    function sendMessage() {
        const user = userInput.value.trim() || "Аноним";
        const text = msgInput.value.trim();

        if (text) {
            // Сохраняем ник в память
            localStorage.setItem('chat_nickname', user);
            
            push(messagesRef, {
                name: user,
                message: text,
                time: serverTimestamp()
            });
            msgInput.value = '';
        }
    }

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // Загрузка последних 100 сообщений
    const lastMessagesQuery = query(messagesRef, limitToLast(100));
    
    onChildAdded(lastMessagesQuery, (snapshot) => {
        const msg = snapshot.val();
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message';
        msgDiv.innerHTML = `<span class="user">${escapeHtml(msg.name)}</span><div class="text">${escapeHtml(msg.message)}</div>`;
        
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    // Защита от XSS (взлома через текст сообщений)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

</body>
</html>
