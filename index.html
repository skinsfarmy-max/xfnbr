<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CloudChat OS: Elite Edition</title>
    <style>
        :root { 
            --bg: #0b0e14; --panel: #1a1d26; --accent: #4285F4; --admin: #ea4335; --border: #2d313d;
            --matrix: #00ff41;
        }
        /* –¢–µ–º—ã */
        body.theme-space { --bg: #020205; --panel: #0b0b1a; --accent: #9b59b6; }
        body.theme-matrix { --bg: #000; --panel: #050505; --accent: #00ff41; --border: #003300; }

        * { box-sizing: border-box; font-family: 'Consolas', 'Monaco', monospace; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; display: flex; flex-direction: column; overflow: hidden; transition: 0.3s; }

        /* –®–∞–ø–∫–∞ */
        header { background: var(--panel); padding: 10px 15px; border-bottom: 2px solid var(--accent); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .boss-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; background: #333; color: #777; transition: 0.5s; }
        .boss-status.online { background: var(--admin); color: white; box-shadow: 0 0 10px var(--admin); }

        /* –ß–∞—Ç */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px; border-radius: 12px; background: var(--panel); border: 1px solid var(--border); position: relative; animation: fadeIn 0.3s ease; }
        .msg.is-me { align-self: flex-end; border-color: var(--accent); }
        .msg.is-admin { border: 1px solid var(--admin); box-shadow: 0 0 5px rgba(234, 67, 53, 0.3); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; cursor: pointer; }
        .msg-header img { width: 24px; height: 24px; border-radius: 50%; }
        .lvl-tag { font-size: 9px; background: #333; padding: 1px 4px; border-radius: 4px; color: #aaa; }

        /* –†–µ–∞–∫—Ü–∏–∏ */
        .reactions { display: flex; gap: 5px; margin-top: 8px; }
        .react-btn { background: rgba(255,255,255,0.05); border: none; border-radius: 5px; color: white; padding: 2px 6px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .react-btn:hover { background: var(--accent); }

        /* –§—É—Ç–µ—Ä */
        footer { padding: 15px; background: var(--panel); border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
        #msg-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; outline: none; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--panel); padding: 25px; border-radius: 15px; width: 320px; text-align: center; border: 1px solid var(--accent); }
        .xp-bar { width: 100%; height: 8px; background: #111; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--accent); width: 0%; transition: 1s; }

        .theme-btn { padding: 5px 10px; font-size: 10px; cursor: pointer; background: #222; border: 1px solid #444; color: white; margin: 2px; }
    </style>
</head>
<body id="main-body">

<div id="login-screen" style="position:fixed; inset:0; background:black; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h1 style="color:var(--accent); letter-spacing: 5px;">CLOUD_OS</h1>
    <button onclick="login()" style="background:none; border: 1px solid var(--accent); color:white; padding:15px 30px; cursor:pointer;">INITIALIZE_LOGIN</button>
</div>

<header>
    <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openProfile(user.uid)">
        <img id="my-pic" src="" style="width:35px; border-radius:50%;">
        <span id="my-name">...</span>
    </div>
    <div id="boss-online" class="boss-status">BOSS OFFLINE</div>
    <div>
        <button class="theme-btn" onclick="setTheme('default')">NOIR</button>
        <button class="theme-btn" onclick="setTheme('space')">SPACE</button>
        <button class="theme-btn" onclick="setTheme('matrix')">MATRIX</button>
    </div>
</header>

<div id="chat-window"></div>

<div id="typing-indicator" style="padding:0 20px; font-size:10px; color:#555;"></div>

<footer>
    <input type="text" id="msg-input" placeholder="Type /dice or message..." autocomplete="off">
    <button onclick="sendMsg()" style="background:var(--accent); border:none; padding:10px 20px; border-radius:5px; color:white; cursor:pointer;">SEND</button>
</footer>

<div id="modal-prof" class="modal">
    <div class="modal-content">
        <img id="view-pic" src="" style="width:80px; border-radius:50%;">
        <h3 id="view-name">...</h3>
        <div id="view-level" style="font-size:12px; color:var(--accent);">LEVEL 1</div>
        <div class="xp-bar"><div id="xp-fill" class="xp-fill"></div></div>
        <p id="view-status" style="font-size:12px; color:#666;"></p>
        
        <div id="edit-box" style="display:none; margin-top:15px;">
            <input type="text" id="inp-status" placeholder="New status..." style="width:100%; background:black; border:1px solid #333; color:white; padding:8px; margin-bottom:10px;">
            <button onclick="saveProfile()" style="width:100%; padding:8px; background:var(--accent); border:none; color:white;">UPDATE</button>
            <button id="admin-ban" onclick="execBan()" style="width:100%; padding:8px; background:var(--admin); border:none; color:white; margin-top:5px; display:none;">BAN USER</button>
        </div>
        <button onclick="closeMod()" style="background:none; border:none; color:#555; margin-top:20px; cursor:pointer;">CLOSE</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, onValue, serverTimestamp, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2KBDPMea8hWT4vv9ac613bQboI4hpAVU",
        authDomain: "chat-a5fe6.firebaseapp.com",
        databaseURL: "https://chat-a5fe6-default-rtdb.firebaseio.com",
        projectId: "chat-a5fe6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    let user = null;
    let targetUID = null;
    const BOSS_EMAIL = "skinsfarmy@gmail.com";

    window.login = () => signInWithPopup(auth, provider);
    window.setTheme = (t) => {
        document.body.className = t === 'default' ? '' : 'theme-' + t;
        localStorage.setItem('chat-theme', t);
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            user = u;
            document.getElementById('login-screen').style.display = 'none';
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
            onValue(ref(db, `banned/${user.uid}`), (s) => { if(s.exists()) location.reload(); });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —é–∑–µ—Ä–∞ (XP, Level)
            const uRef = ref(db, `users/${user.uid}`);
            const snap = await get(uRef);
            if (!snap.exists()) {
                await update(uRef, { name: user.displayName, pic: user.photoURL, xp: 0, lvl: 1, status: "System ready." });
            }

            // –°—Ç–∞—Ç—É—Å –ë–æ—Å—Å–∞
            if (user.email === BOSS_EMAIL) {
                update(ref(db, 'status/boss'), { online: true, last: serverTimestamp() });
                window.addEventListener('beforeunload', () => update(ref(db, 'status/boss'), { online: false }));
            }

            onValue(ref(db, 'status/boss/online'), (s) => {
                const el = document.getElementById('boss-online');
                if(s.val()) { el.innerText = "BOSS ONLINE"; el.classList.add('online'); }
                else { el.innerText = "BOSS OFFLINE"; el.classList.remove('online'); }
            });

            document.getElementById('my-name').innerText = user.displayName;
            document.getElementById('my-pic').src = user.photoURL;
            loadMessages();
        }
    });

    // --- –°–ò–°–¢–ï–ú–ê –°–û–û–ë–©–ï–ù–ò–ô ---
    window.sendMsg = async () => {
        const input = document.getElementById('msg-input');
        let text = input.value.trim();
        if(!text) return;

        // –ö–æ–º–∞–Ω–¥–∞ DICE
        if(text === '/dice') {
            text = `üé≤ –í—ã–±—Ä–æ—Å–∏–ª —á–∏—Å–ª–æ: ${Math.floor(Math.random() * 100) + 1}`;
        }

        const uSnap = await get(ref(db, `users/${user.uid}`));
        const data = uSnap.val();
        
        // –î–æ–±–∞–≤–ª—è–µ–º XP –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const newXP = (data.xp || 0) + 10;
        const newLvl = Math.floor(newXP / 100) + 1;
        update(ref(db, `users/${user.uid}`), { xp: newXP, lvl: newLvl });

        push(ref(db, 'chat_v3'), {
            uid: user.uid, u: data.name, p: data.pic,
            m: text, lvl: newLvl, isA: (user.email === BOSS_EMAIL),
            t: serverTimestamp()
        });
        input.value = '';
    };

    function loadMessages() {
        onChildAdded(ref(db, 'chat_v3'), (snap) => {
            const d = snap.val();
            const id = snap.key;
            const isMe = d.uid === user.uid;
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'is-me' : ''} ${d.isA ? 'is-admin' : ''}`;
            div.innerHTML = `
                <div class="msg-header" onclick="openProfile('${d.uid}')">
                    <img src="${d.p}">
                    <span style="font-size:12px; font-weight:bold;">${d.u}</span>
                    <span class="lvl-tag">LVL ${d.lvl}</span>
                </div>
                <div style="font-size:14px; color:#ddd;">${escape(d.m)}</div>
                <div class="reactions">
                    <button class="react-btn" onclick="react('${id}', 'üî•')">üî•</button>
                    <button class="react-btn" onclick="react('${id}', 'üëç')">üëç</button>
                    ${(user.email === BOSS_EMAIL) ? `<button onclick="delMsg('${id}')" style="background:none; border:none; color:red; cursor:pointer; font-size:10px;">[DELETE]</button>` : ''}
                </div>
            `;
            document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTo(0, document.getElementById('chat-window').scrollHeight);
        });
    }

    // --- –ü–†–û–§–ò–õ–¨ –ò XP ---
    window.openProfile = async (uid) => {
        targetUID = uid;
        const s = await get(ref(db, `users/${uid}`));
        const data = s.val();
        
        document.getElementById('view-pic').src = data.pic;
        document.getElementById('view-name').innerText = data.name;
        document.getElementById('view-status').innerText = data.status;
        document.getElementById('view-level').innerText = `LEVEL ${data.lvl}`;
        
        const progress = (data.xp % 100);
        document.getElementById('xp-fill').style.width = progress + '%';
        
        document.getElementById('edit-box').style.display = (uid === user.uid || user.email === BOSS_EMAIL) ? 'block' : 'none';
        document.getElementById('admin-ban').style.display = (user.email === BOSS_EMAIL && uid !== user.uid) ? 'block' : 'none';
        
        document.getElementById('modal-prof').style.display = 'flex';
    };

    window.saveProfile = () => {
        const st = document.getElementById('inp-status').value;
        update(ref(db, `users/${targetUID}`), { status: st });
        closeMod();
    };

    window.closeMod = () => document.getElementById('modal-prof').style.display = 'none';
    window.delMsg = (id) => remove(ref(db, `chat_v3/${id}`));
    window.execBan = () => update(ref(db, `banned/${targetUID}`), { t: Date.now() });

    function escape(s) { let t = document.createElement('div'); t.textContent = s; return t.innerHTML; }
    document.getElementById('msg-input').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
    const savedTheme = localStorage.getItem('chat-theme');
    if(savedTheme) setTheme(savedTheme);
</script>
</body>
</html>
