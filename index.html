<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudChat Prime</title>
    <style>
        :root {
            --bg: #0f111a;
            --surface: #1a1c29;
            --accent: #7289da;
            --admin-gold: #ffcc00;
            --text: #ffffff;
        }

        * { box-sizing: border-box; transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* –ü—Ä–æ—Ñ–∏–ª—å –∏ –†–∞–Ω–≥–∏ */
        header { 
            background: var(--surface); padding: 15px 20px; border-bottom: 2px solid #2d2f3f;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
        }
        .user-card { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 12px; }
        .avatar-circle { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 2px solid rgba(255,255,255,0.1); }
        
        .profile-inputs input { 
            background: #2d2f3f; border: 1px solid #3d3f4f; color: white; 
            padding: 8px 12px; border-radius: 8px; outline: none; width: 140px; font-size: 13px;
        }
        .profile-inputs input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(114,137,218,0.3); }

        /* –û–∫–Ω–æ —á–∞—Ç–∞ */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg { 
            background: var(--surface); padding: 12px 16px; border-radius: 4px 18px 18px 18px; 
            max-width: 85%; width: fit-content; position: relative; border-left: 3px solid var(--accent);
            animation: emerge 0.3s ease-out;
        }
        @keyframes emerge { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –≠–§–§–ï–ö–¢–´ –°–û–ó–î–ê–¢–ï–õ–Ø --- */
        .is-creator { 
            border: 2px solid transparent;
            border-image: linear-gradient(45deg, #ff0000, #fffb00, #00ffd5, #ff00c8) 1;
            background: linear-gradient(rgba(26,28,41,0.95), rgba(26,28,41,0.95)) padding-box, 
                        linear-gradient(45deg, #ff0000, #fffb00, #00ffd5, #ff00c8) border-box !important;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.2);
        }
        .creator-text {
            background: linear-gradient(to right, #fffb00, #ff00c8, #00ffd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            animation: rainbow-text 3s infinite linear;
        }
        @keyframes rainbow-text { from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); } }

        .rank-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-bottom: 4px; display: inline-block; letter-spacing: 0.5px; }
        .tag-creator { background: var(--admin-gold); color: black; }
        .tag-member { background: #3d3f4f; color: #aaa; }

        /* –§—É—Ç–µ—Ä */
        footer { background: var(--surface); padding: 15px 25px; display: flex; gap: 12px; align-items: center; }
        #msg-input { flex: 1; background: #2d2f3f; border: none; padding: 14px 20px; border-radius: 25px; color: white; outline: none; }
        #send-btn { background: var(--accent); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        #send-btn:hover { transform: scale(1.1) rotate(5deg); background: #5b6eae; }

        /* –°–∫—Ä—ã—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞ */
        .admin-controls { display: none; background: #cf222e; color: white; text-align: center; padding: 5px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .is-master .admin-controls { display: block; }
        
        .delete-x { color: #ff4d4d; font-weight: bold; cursor: pointer; margin-left: 10px; font-size: 14px; opacity: 0.3; }
        .delete-x:hover { opacity: 1; }
    </style>
</head>
<body id="app-body">

<div class="admin-controls" onclick="window.clearChat()">[ –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï –°–û–û–ë–©–ï–ù–ò–Ø ]</div>

<header>
    <div class="user-card">
        <div id="p-avatar" class="avatar-circle">üë§</div>
        <div>
            <div style="font-size: 12px; color: #888;">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div id="p-lvl" style="font-size: 10px; color: var(--accent); font-weight: bold;">Level 1 (XP: 0)</div>
        </div>
    </div>
    <div class="profile-inputs">
        <input type="text" id="username" placeholder="–í–∞—à –Ω–∏–∫" maxlength="15">
        <input type="text" id="email" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–∞—è –ø–æ—á—Ç–∞">
    </div>
</header>

<div id="chat-window"></div>

<footer>
    <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
    <button id="send-btn">üöÄ</button>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, remove, serverTimestamp, query, limitToLast, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD2KBDPMea8hWT4vv9ac613bQboI4hpAVU",
        authDomain: "chat-a5fe6.firebaseapp.com",
        databaseURL: "https://chat-a5fe6-default-rtdb.firebaseio.com",
        projectId: "chat-a5fe6",
        storageBucket: "chat-a5fe6.firebasestorage.app",
        messagingSenderId: "297636975324",
        appId: "1:297636975324:web:de823d9d84a7abc3801a19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, 'chat_data');
    const MASTER = "skinsfarmy@gmail.com";

    const chatWindow = document.getElementById('chat-window');
    const msgInput = document.getElementById('msg-input');
    const emailInput = document.getElementById('email');
    const userInput = document.getElementById('username');

    // --- –õ–û–ì–ò–ö–ê XP –ò –†–ê–ù–ì–û–í ---
    let xp = parseInt(localStorage.getItem('chat_xp') || 0);
    const updateXP = () => {
        xp += 5;
        localStorage.setItem('chat_xp', xp);
        const lvl = Math.floor(xp / 100) + 1;
        document.getElementById('p-lvl').innerText = `Level ${lvl} (XP: ${xp})`;
    };

    const avas = ['üî•', 'üëæ', 'üëª', 'üíé', 'ü¶ä', 'üöÄ', '‚≠ê', 'üçÄ'];
    const getAva = (nick) => avas[nick.length % avas.length];

    window.checkMaster = () => {
        const mail = emailInput.value.trim().toLowerCase();
        localStorage.setItem('chat_email', mail);
        mail === MASTER ? document.getElementById('app-body').classList.add('is-master') : document.getElementById('app-body').classList.remove('is-master');
    };
    emailInput.oninput = window.checkMaster;

    userInput.value = localStorage.getItem('chat_nick') || "";
    emailInput.value = localStorage.getItem('chat_email') || "";
    window.checkMaster();

    // --- –û–¢–ü–†–ê–í–ö–ê ---
    window.send = () => {
        const text = msgInput.value.trim();
        const nick = userInput.value.trim() || "–ê–Ω–æ–Ω–∏–º";
        if (text) {
            localStorage.setItem('chat_nick', nick);
            push(chatRef, { u: nick, m: text, e: emailInput.value.trim().toLowerCase(), t: serverTimestamp() });
            msgInput.value = '';
            updateXP();
        }
    };

    document.getElementById('send-btn').onclick = window.send;
    msgInput.onkeypress = (e) => { if(e.key === 'Enter') window.send(); };
    window.clearChat = () => { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) set(chatRef, null); };
    window.del = (id) => remove(ref(db, `chat_data/${id}`));

    // --- –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ---
    onChildAdded(query(chatRef, limitToLast(40)), (snap) => {
        const d = snap.val();
        const id = snap.key;
        const isM = d.e === MASTER;
        const time = d.t ? new Date(d.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";

        const div = document.createElement('div');
        div.className = `msg ${isM ? 'is-creator' : ''}`;
        div.id = 'm-' + id;
        
        // –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ
        let messageHTML = escape(d.m);
        if (d.m.match(/\.(jpeg|jpg|gif|png)$/) != null || d.m.includes('http')) {
            messageHTML = messageHTML.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#7289da">$1</a>');
        }

        div.innerHTML = `
            <span class="rank-tag ${isM ? 'tag-creator' : 'tag-member'}">${isM ? 'OWNER' : 'LEVEL ' + (Math.floor(d.u.length * 1.5))}</span>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                <span style="font-size:14px;">${getAva(d.u)}</span>
                <span class="${isM ? 'creator-text' : ''}" style="font-weight:bold; font-size:13px; color:${isM ? '#fff' : '#7289da'}">${escape(d.u)}</span>
            </div>
            <div style="font-size:14px; line-height:1.4;">${messageHTML}</div>
            <div style="text-align:right; margin-top:5px; font-size:9px; color:#555;">
                ${time}
                ${document.getElementById('app-body').classList.contains('is-master') ? `<span class="delete-x" onclick="del('${id}')">√ó</span>` : ''}
            </div>
        `;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    });

    onChildRemoved(chatRef, (s) => document.getElementById('m-' + s.key)?.remove());

    function escape(s) {
        let t = document.createElement('div');
        t.textContent = s;
        return t.innerHTML;
    }
</script>

</body>
</html>
